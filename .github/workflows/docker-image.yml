# GitHub Actions å·¥ä½œæµï¼šæ„å»ºå¹¶æ¨é€ Docker é•œåƒåˆ° GitHub Container Registry
# æ­¤å·¥ä½œæµæ”¯æŒå¤šå¹³å°æ„å»ºï¼ˆamd64/arm64ï¼‰å¹¶è‡ªåŠ¨ç®¡ç†é•œåƒæ ‡ç­¾

name: Build and Push Docker Image

# å·¥ä½œæµè§¦å‘æ¡ä»¶
on:
  # æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è¿è¡Œå·¥ä½œæµ
  workflow_dispatch:
  
  # æ¨é€è§¦å‘ï¼šå½“ä»£ç æ¨é€åˆ°æŒ‡å®šåˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches:
      - master      # ä¸»åˆ†æ”¯
      - main        # ä¸»åˆ†æ”¯ï¼ˆGitHub æ–°é»˜è®¤åˆ†æ”¯åï¼‰
    tags:
      - 'v*'        # ç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚ v1.0.0, v2.1.3 ç­‰ï¼‰
  
  # Pull Request è§¦å‘ï¼šä»…æ„å»ºä½†ä¸æ¨é€ï¼Œç”¨äºéªŒè¯æ„å»ºè¿‡ç¨‹
  pull_request:
    branches:
      - master
      - main

# ç¯å¢ƒå˜é‡å®šä¹‰
env:
  # GitHub Container Registry åœ°å€
  REGISTRY: ghcr.io
  # é•œåƒåç§°ï¼Œä½¿ç”¨ä»“åº“åç§°ä½œä¸ºé•œåƒå
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # æ„å»ºå’Œæ¨é€ä»»åŠ¡
  build-and-push:
    # è¿è¡Œç¯å¢ƒï¼šä½¿ç”¨æœ€æ–°çš„ Ubuntu
    runs-on: ubuntu-latest
    
    # è®¾ç½®æƒé™ï¼šå…è®¸è¯»å–ä»“åº“å†…å®¹å’Œå†™å…¥åŒ…
    permissions:
      contents: read      # è¯»å–ä»“åº“ä»£ç 
      packages: write     # å†™å…¥ GitHub Packages (GHCR)
    
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      # ä¸‹è½½ä»“åº“ä»£ç åˆ°è¿è¡Œå™¨ï¼ŒåŒ…æ‹¬å­æ¨¡å—
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          submodules: true    # åŒæ—¶æ‹‰å– Git å­æ¨¡å—

      # æ­¥éª¤2ï¼šè®¾ç½® QEMU
      # QEMU ç”¨äºæ¨¡æ‹Ÿä¸åŒçš„ CPU æ¶æ„ï¼Œæ”¯æŒäº¤å‰ç¼–è¯‘
      - name: è®¾ç½® QEMU æ¨¡æ‹Ÿå™¨
        uses: docker/setup-qemu-action@v3

      # æ­¥éª¤3ï¼šè®¾ç½® Docker Buildx
      # Buildx æ˜¯ Docker çš„æ‰©å±•æ„å»ºå™¨ï¼Œæ”¯æŒå¤šå¹³å°æ„å»ºå’Œé«˜çº§åŠŸèƒ½
      - name: è®¾ç½® Docker Buildx æ„å»ºå™¨
        uses: docker/setup-buildx-action@v3

      # æ­¥éª¤4ï¼šæå–å…ƒæ•°æ®
      # æ ¹æ® Git åˆ†æ”¯ã€æ ‡ç­¾ç­‰ä¿¡æ¯è‡ªåŠ¨ç”Ÿæˆ Docker é•œåƒæ ‡ç­¾å’Œæ ‡ç­¾
      - name: æå–é•œåƒå…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          # é•œåƒä»“åº“åœ°å€
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          # æ ‡ç­¾ç”Ÿæˆè§„åˆ™
          tags: |
            # åˆ†æ”¯åæ ‡ç­¾ï¼šå¦‚ master, main, feature-branch
            type=ref,event=branch
            # PR æ ‡ç­¾ï¼šå¦‚ pr-123
            type=ref,event=pr
            # è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾ï¼šä» git æ ‡ç­¾æå–
            type=semver,pattern={{version}}      # å®Œæ•´ç‰ˆæœ¬å·ï¼šv1.2.3 -> 1.2.3
            type=semver,pattern={{major}}.{{minor}}  # ä¸»æ¬¡ç‰ˆæœ¬å·ï¼šv1.2.3 -> 1.2
            type=semver,pattern={{major}}        # ä¸»ç‰ˆæœ¬å·ï¼šv1.2.3 -> 1
            # latest æ ‡ç­¾ï¼šä»…åœ¨é»˜è®¤åˆ†æ”¯ï¼ˆmaster/mainï¼‰ä¸Šç”Ÿæˆ
            type=raw,value=latest,enable={{is_default_branch}}

      # æ­¥éª¤5ï¼šé…ç½® Docker å±‚ç¼“å­˜
      # ç¼“å­˜ Docker æ„å»ºå±‚ä»¥åŠ é€Ÿåç»­æ„å»º
      - name: é…ç½® Docker æ„å»ºç¼“å­˜
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache     # ç¼“å­˜è·¯å¾„
          # ç¼“å­˜é”®ï¼šåŸºäºæ“ä½œç³»ç»Ÿå’Œæäº¤å“ˆå¸Œ
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          # ç¼“å­˜æ¢å¤é”®ï¼šå¦‚æœç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œä½¿ç”¨è¿™äº›å‰ç¼€åŒ¹é…
          restore-keys: |
            ${{ runner.os }}-buildx-

      # æ­¥éª¤6ï¼šç™»å½•åˆ° GitHub Container Registry
      # åªåœ¨é PR æƒ…å†µä¸‹ç™»å½•ï¼ˆPR åªæ„å»ºä¸æ¨é€ï¼‰
      - name: ç™»å½•åˆ° GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          # ä½¿ç”¨ GitHub Actorï¼ˆè§¦å‘å·¥ä½œæµçš„ç”¨æˆ·ï¼‰ä½œä¸ºç”¨æˆ·å
          username: ${{ github.actor }}
          # ä½¿ç”¨ GitHub æä¾›çš„ä»¤ç‰Œè¿›è¡Œè®¤è¯
          password: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤7ï¼šæ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      # æ‰§è¡Œå¤šå¹³å°æ„å»ºå¹¶æ¨é€åˆ° GHCR
      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .                   # æ„å»ºä¸Šä¸‹æ–‡ï¼šå½“å‰ç›®å½•
          # æ”¯æŒçš„å¹³å°æ¶æ„
          platforms: linux/amd64,linux/arm64
          # æ¨é€æ¡ä»¶ï¼šåªåœ¨é PR æ—¶æ¨é€é•œåƒ
          push: ${{ github.event_name != 'pull_request' }}
          # ä½¿ç”¨å‰é¢ç”Ÿæˆçš„æ ‡ç­¾
          tags: ${{ steps.meta.outputs.tags }}
          # ä½¿ç”¨å‰é¢ç”Ÿæˆçš„æ ‡ç­¾ï¼ˆåŒ…å«æ„å»ºæ—¶é—´ã€ç‰ˆæœ¬ç­‰å…ƒä¿¡æ¯ï¼‰
          labels: ${{ steps.meta.outputs.labels }}
          # ç¼“å­˜é…ç½®ï¼šä»æœ¬åœ°ç¼“å­˜è¯»å–
          cache-from: type=local,src=/tmp/.buildx-cache
          # ç¼“å­˜é…ç½®ï¼šå†™å…¥æœ¬åœ°ç¼“å­˜ï¼Œä½¿ç”¨æœ€å¤§æ¨¡å¼
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      # æ­¥éª¤8ï¼šæ›´æ–°ç¼“å­˜
      # å°†æ–°çš„ç¼“å­˜ç›®å½•æ›¿æ¢æ—§çš„ï¼Œé¿å…ç¼“å­˜æ–‡ä»¶å†²çª
      - name: æ›´æ–°æ„å»ºç¼“å­˜
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      # æ­¥éª¤9ï¼šè¾“å‡ºé•œåƒæ‘˜è¦
      # æ˜¾ç¤ºæ„å»ºçš„é•œåƒ SHA256 æ‘˜è¦ï¼Œç”¨äºéªŒè¯å’Œè¿½è¸ª
      - name: è¾“å‡ºé•œåƒæ‘˜è¦ä¿¡æ¯
        if: github.event_name != 'pull_request'
        run: |
          echo "ğŸ‰ é•œåƒæ„å»ºå®Œæˆï¼"
          echo "ğŸ“¦ é•œåƒæ‘˜è¦: ${{ steps.meta.outputs.digest }}"
          echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾:"
          echo "${{ steps.meta.outputs.tags }}" | while read tag; do
            echo "   - $tag"
          done

      # æ­¥éª¤10ï¼šè®¾ç½®é•œåƒä¸ºå…¬å¼€
      # ä½¿ç”¨ GitHub CLI å°†æ¨é€çš„åŒ…è®¾ç½®ä¸ºå…¬å¼€å¯è§
      - name: è®¾ç½®é•œåƒåŒ…ä¸ºå…¬å¼€
        if: github.event_name != 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æå–ä»“åº“åç§°ä½œä¸ºåŒ…å
          PACKAGE_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          echo "ğŸ“‹ è®¾ç½®åŒ… '$PACKAGE_NAME' ä¸ºå…¬å¼€..."
          
          # ä½¿ç”¨ GitHub CLI è®¾ç½®åŒ…å¯è§æ€§ä¸ºå…¬å¼€
          # æ³¨æ„ï¼šè¿™éœ€è¦ä»“åº“æœ‰è¶³å¤Ÿçš„æƒé™
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/orgs/${{ github.repository_owner }}/packages/container/$PACKAGE_NAME" \
            -f visibility='public' || \
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/users/${{ github.repository_owner }}/packages/container/$PACKAGE_NAME" \
            -f visibility='public' || \
          echo "âš ï¸  æ— æ³•è®¾ç½®åŒ…ä¸ºå…¬å¼€ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨åœ¨ GitHub åŒ…é¡µé¢è®¾ç½®"
